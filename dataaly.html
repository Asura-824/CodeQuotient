<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="/Assests/style.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js">
	<title>Interactive Data Visualizer & Python Code Generator</title>
	<style>
		/* Main Content Layout */
		.main-content {
			max-width: 1280px; /* max-w-10xl approximation */
			margin-left: auto;
			margin-right: auto;
			padding: 1.5rem; /* added for better spacing */
		}
		.main-title {
			font-size: 2.25rem; /* text-4xl */
			font-weight: 800; /* font-extrabold */
			color: #1d4ed8; /* text-blue-700 */
			margin-bottom: 1.5rem; /* mb-6 */
			display: flex;
			align-items: center;
		}
		.icon-lg {
			height: 2.5rem; /* h-10 */
			width: 2.5rem; /* w-10 */
			margin-right: 0.75rem; /* mr-3 */
		}

		/* Dropzone */
		.dropzone {
			border: 4px dashed #d1d5db; /* border-4 border-dashed border-gray-300 */
			background-color: white;
			border-radius: 0.75rem; /* rounded-xl */
			padding: 2rem; /* p-8 */
			text-align: center;
			color: #4b5563; /* text-gray-600 */
			transition: all 0.3s ease; /* transition duration-300 */
			box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
			margin-bottom: 1.5rem; /* mb-6 */
		}
		.dropzone:hover {
			border-color: #3b82f6; /* hover:border-blue-500 */
			color: #2563eb; /* hover:text-blue-600 */
		}
		.dropzone-title {
			font-weight: 600; /* font-semibold */
			font-size: 1.25rem; /* text-xl */
		}
		.dropzone-text {
			font-size: 0.875rem; /* text-sm */
			margin-top: 0.5rem; /* my-2 */
			margin-bottom: 0.5rem;
		}
		.file-input {
			display: block;
			margin-left: auto;
			margin-right: auto;
		}

		/* Controls Panel */
		.controls-panel {
			padding: 1.5rem; /* p-6 */
			background-color: white;
			box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
			border-radius: 0.75rem; /* rounded-xl */
			margin-bottom: 1.5rem; /* mb-6 */
		}
		.panel-title {
			font-size: 1.5rem; /* text-2xl */
			font-weight: 700; /* font-bold */
			margin-bottom: 1rem; /* mb-4 */
			color: #374151; /* text-gray-700 */
			border-bottom: 1px solid #e5e7eb; /* border-b */
			padding-bottom: 0.5rem; /* pb-2 */
		}
		.plot-config-grid {
			display: grid;
			grid-template-columns: repeat(1, minmax(0, 1fr));
			gap: 1.5rem; /* gap-6 */
			margin-bottom: 1.5rem; /* mb-6 */
		}
		@media (min-width: 768px) {
			.plot-config-grid {
				grid-template-columns: repeat(4, minmax(0, 1fr)); /* md:grid-cols-4 */
			}
		}
		.col-span-1 {
			grid-column: span 1 / span 1;
		}

		/* Control Elements */
		.control-label {
			display: block;
			font-weight: 600; /* font-semibold */
			font-size: 0.875rem; /* text-sm */
			margin-bottom: 0.25rem; /* mb-1 */
			color: #2563eb; /* text-blue-600 */
		}
		.control-label-green {
			color: #059669; /* text-green-600 */
		}
		.control-label-purple {
			color: #7c3aed; /* text-purple-600 */
		}
		.control-select, .control-input {
			padding: 0.5rem; /* p-2 */
			border: 1px solid #d1d5db; /* border border-gray-300 */
			border-radius: 0.5rem; /* rounded-lg */
			box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
			width: 100%; /* w-full */
		}
		.control-select:focus, .control-input:focus {
			outline: 2px solid transparent;
			outline-offset: 2px;
			box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); /* focus:ring-blue-500 */
			border-color: #3b82f6; /* focus:border-blue-500 */
		}

		.x-select-container {
			padding: 0.5rem;
			border: 1px solid #d1d5db;
			border-radius: 0.5rem;
			box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
			width: 100%;
			color: black;
			background-color: white;
			height: 7rem; /* h-28 */
			overflow-y: auto;
		}
		.placeholder-text {
			color: #9ca3af; /* text-gray-400 */
			font-size: 0.875rem; /* text-sm */
		}
		.helper-text {
			font-size: 0.75rem; /* text-xs */
			color: #6b7280; /* text-gray-500 */
			margin-top: 0.25rem; /* mt-1 */
		}
		.warning-text {
			font-size: 0.75rem;
			color: #ef4444; /* text-red-500 */
			margin-top: 0.25rem;
		}

		/* Checkbox Styling */
		.checkbox-item {
			display: flex;
			align-items: center;
			margin-top: 0.25rem;
			margin-bottom: 0.25rem;
			font-size: 0.875rem; /* text-sm */
			column-gap: 0.5rem; /* space-x-2 */
		}
		.checkbox-input {
			border-radius: 0.25rem; /* rounded */
			color: #2563eb; /* text-blue-600 */
			box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
		}
		.cursor-pointer {
			cursor: pointer;
		}
		
		/* Filter Panel */
		.filter-panel {
			border: 1px solid #e5e7eb; /* border border-gray-200 */
			padding: 1rem; /* p-4 */
			border-radius: 0.5rem; /* rounded-lg */
			background-color: #f9fafb; /* bg-gray-50 */
			margin-top: 1rem; /* mt-4 */
		}
		.filter-title {
			font-size: 1.125rem; /* text-lg */
			font-weight: 700; /* font-bold */
			margin-bottom: 0.75rem; /* mb-3 */
			color: #dc2626; /* text-red-600 */
			display: flex;
			align-items: center;
		}
		.icon-sm {
			height: 1.25rem; /* h-5 */
			width: 1.25rem; /* w-5 */
			margin-right: 0.5rem; /* mr-2 */
		}
		.filter-grid {
			display: grid;
			grid-template-columns: repeat(1, minmax(0, 1fr));
			gap: 1rem; /* gap-4 */
		}
		@media (min-width: 768px) {
			.filter-grid {
				grid-template-columns: repeat(3, minmax(0, 1fr)); /* md:grid-cols-3 */
			}
		}

		/* Buttons */
		.button-group {
			display: flex;
			flex-wrap: wrap;
			gap: 1rem; /* gap-4 */
			margin-top: 1.5rem; /* mt-6 */
		}
		.button-base {
			font-weight: 700; /* font-bold */
			padding: 0.5rem 1.5rem; /* py-2 px-6 */
			border-radius: 0.5rem; /* rounded-lg */
			transition: background-color 0.15s ease; /* transition duration-150 */
			box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
			border: none;
			cursor: pointer;
		}
		.button-primary { /* Plot Button */
			background-color: #16a34a; /* bg-green-600 */
			color: white;
		}
		.button-primary:hover {
			background-color: #15803d; /* hover:bg-green-700 */
		}
		.button-secondary { /* Code Button */
			background-color: #4f46e5; /* bg-indigo-600 */
			color: white;
		}
		.button-secondary:hover:not(:disabled) {
			background-color: #4338ca; /* hover:bg-indigo-700 */
		}
		.button-secondary:disabled {
			background-color: #818cf8; /* disabled:bg-indigo-400 */
			cursor: not-allowed;
		}
		
		/* Chart Container */
		#chart-container { 
			position: relative; 
			width: 100%; 
			height: 500px; 
			background-color: white; 
			border-radius: 0.75rem; 
			padding: 1rem; 
			box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); 
		}
		#chart { min-height: 400px; width: 100%; }

		/* Result Box */
		.result-box {
			margin-top: 1.5rem; /* mt-6 */
			padding: 1rem; /* p-4 */
			background-color: white;
			border-radius: 0.75rem; /* rounded-xl */
			box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
			white-space: pre-line;
			font-size: 0.875rem; /* text-sm */
			color: #374151; /* text-gray-700 */
		}
		
		/* Code Modal Styles (Kept largely as original to minimize changes to non-Tailwind CSS) */
		.modal-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.75);
			display: none;
			justify-content: center;
			align-items: center;
			z-index: 1000;
			backdrop-filter: blur(5px);
			overflow-y: auto;
		}
		.modal-content {
			background: white;
			padding: 24px;
			border-radius: 12px;
			width: 90%;
			max-width: 800px;
			max-height: 90vh; 
			box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
		}
		.modal-title {
			font-size: 1.5rem; /* text-2xl */
			font-weight: 700;
			color: #4338ca; /* text-indigo-700 */
			margin-bottom: 1rem;
			border-bottom: 1px solid #e5e7eb;
			padding-bottom: 0.5rem;
		}
		.modal-subtitle {
			font-size: 0.875rem;
			color: #4b5563; /* text-gray-600 */
			margin-bottom: 1rem;
		}
		pre {
			background: #282c34; /* Dark background for code */
			color: #abb2bf; /* Light text color */
			padding: 16px;
			border-radius: 6px;
			overflow-x: auto;
			white-space: pre-wrap;
		}

		/* Modal Buttons */
		.modal-button-group {
			display: flex;
			justify-content: flex-end;
			column-gap: 0.75rem; /* space-x-3 */
			margin-top: 1.5rem; /* mt-6 */
		}
		.button-copy {
			background-color: #2563eb; /* bg-blue-600 */
			color: white;
			font-weight: 700;
			padding: 0.5rem 1rem;
			border-radius: 0.5rem;
			transition: background-color 0.15s ease;
			box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
			border: none;
			cursor: pointer;
		}
		.button-copy:hover {
			background-color: #1d4ed8; /* hover:bg-blue-700 */
		}
		.button-close {
			background-color: #d1d5db; /* bg-gray-300 */
			color: #374151; /* text-gray-800 */
			font-weight: 700;
			padding: 0.5rem 1rem;
			border-radius: 0.5rem;
			transition: background-color 0.15s ease;
			box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
			border: none;
			cursor: pointer;
		}
		.button-close:hover {
			background-color: #9ca3af; /* hover:bg-gray-400 */
		}

		/* Footer Styles */
		.footer-container-wrap {
			max-width: 1280px; /* max-w-10xl approximation */
			margin-left: auto;
			margin-right: auto;
		}
	</style>

	<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="no-margin-padding">
<header class="header">
        <div class="container">
            <div class="header-top">
                <div class="logo">
                    <img src="/Images/logo.png" alt="logo">
                    SHUBHAM's CodeQuotient
                </div>
                <nav>
                     <ul class="navlinks">
                        <li><a href="/index.html">Home</a></li>
                        <li><a href="/features.html">Features</a></li>
                        <li><a href="/resume.html">Resume</a></li>
                        <li><a href="/Projects/projects.html">Projects</a></li>
                        <li><a href="/contactus.html">Contact</a></li>
                    </ul>
                </nav>
                <div class="right-section">
                    <input type="text" placeholder="Search..." class="search-bar">  
                    
                    <div class="logged-out-buttons" id="logged-out-buttons">
                        <button class="header-button" onclick="location.href='/Login/login.html'">Login</button>
                        <button class="header-button" onclick="location.href='/Signup/signup.html'">Signup</button>
                    </div>

                    <div class="user-info" id="user-info">
                        <span class="user-name" id="display-user-email">Hello, User!</span>
                        <button class="logout-button">Logout</button>
                    </div>
                </div>
            </div>
            <div class="header-bottom">
               <ul class="secondary-nav">
                <input type="text" placeholder="Search..." class="search-bar">
                    <li class="dropdown">
                    <a href="#tutorials">Tutorials <i class="fas fa-chevron-down dropdown-icon"></i></a>
                    <div class="dropdown-content">
                            <a href="/Tutorials/Github/github.html">GitHub</a>
                            <a href="/Tutorials/Python/python.html">Python</a>
                            <a href="/Tutorials/SQL/sql.html">Sql</a>
                            <a href="/Tutorials/Pandas/pandas.html">Pandas</a>
                            <a href="/Tutorials/Numpy/numpy.html">NumPy</a>
                            <a href="/Tutorials/Matplot/matplot.html">Matplot</a>
                            <a href="/Tutorials/R Programming/R programming.html">R programming</a>
                            <a href="/Tutorials/PostgreSQL/postgresql.html">Postgre Sql</a>
                            <a href="/Tutorials/Excel/excel.html">Excel</a>
                            <a href="/Tutorials/Power Bi/powerbi.html">Power Bi</a>
                    </div>
                    </li>
                </ul>
            </div>
        </div>
    </header>
<div class="main-content">
	<h1 class="main-title">
		<svg xmlns="http://www.w3.org/2000/svg" class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
			<path d="M12 20V10M18 20V4M6 20v-4" />
			<rect x="1" y="16" width="22" height="4" rx="1" />
		</svg>
		Interactive Data Visualizer
	</h1>

	<div id="dropzone" class="dropzone">
		<p class="dropzone-title">Drop a CSV or XLSX file here</p>
		<p class="dropzone-text">or select a file:</p>
		<input type="file" id="fileInput" accept=".csv,.xlsx" class="file-input">
	</div>

	<div class="controls-panel">
		<h2 class="panel-title">Plot Configuration</h2>

		<div class="plot-config-grid">
			<div class="col-span-1">
				<label class="control-label" for="xSelectContainer">X-Axis (Group By) Columns:</label>
				<div id="xSelectContainer" class="x-select-container">
					<p class="placeholder-text">Load data to see columns.</p>
				</div>
				<p class="helper-text">Select one or more columns for grouping (e.g., State & City).</p>
			</div>
			
			<div>
				<label class="control-label" for="ySelect">Y-Axis (Value) Column:</label>
				<select id="ySelect" class="control-select"></select>
				<p class="helper-text">Numeric column to aggregate.</p>
			</div>
			
			<div>
				<label class="control-label control-label-green" for="aggMethodSelect">Aggregation Method:</label>
				<select id="aggMethodSelect" class="control-select">
					<option value="mean">Mean (Average)</option>
					<option value="sum">Sum</option>
					<option value="count">Count (Records)</option>
					<option value="min">Min</option>
					<option value="max">Max</option>
				</select>
				<p class="helper-text">Calculation applied to Y-Axis column per group.</p>
			</div>
			
			<div>
				<label class="control-label control-label-purple" for="plotTypeSelect">Plot Type:</label>
				<select id="plotTypeSelect" class="control-select">
					<option value="bar">Bar Plot</option>
					<option value="line">Line Plot</option>
					<option value="scatter" disabled>Scatter (No Aggregation)</option>
					<option value="hist" disabled>Histogram (Single Column)</option>
				</select>
				<p class="warning-text" id="typeWarning"></p>
			</div>
		</div>

		<div class="filter-panel">
			<h3 class="filter-title">
				<svg xmlns="http://www.w3.org/2000/svg" class="icon-sm" viewBox="0 0 20 20" fill="currentColor">
					<path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" />
				</svg>
				Data Filter (Optional - Can use Group By columns)
			</h3>
			<div class="filter-grid">
				<div>
					<label class="block font-semibold text-sm mb-1" for="filterColSelect">Filter Column:</label>
					<select id="filterColSelect" class="control-select">
						<option value="">(None)</option>
					</select>
				</div>
				<div>
					<label class="block font-semibold text-sm mb-1" for="filterOpSelect">Filter Operator:</label>
					<select id="filterOpSelect" class="control-select">
						<option value="===">Equals (=)</option>
						<option value="!==">Not Equals (!=)</option>
						<option value=">">Greater Than (>)</option>
						<option value="<">Less Than (<)</option>
					</select>
				</div>
				<div>
					<label class="block font-semibold text-sm mb-1" for="filterValueInput">Filter Value:</label>
					<input type="text" id="filterValueInput" placeholder="Enter value (e.g., WA or 2015)" class="control-input">
				</div>
			</div>
		</div>
		
		<div class="button-group">
			<button id="plotBtn" class="button-base button-primary">
				Generate Plot
			</button>
			<button id="codeBtn" class="button-base button-secondary" disabled>
				View Python Code
			</button>
		</div>
	</div>

	<div id="chart-container">
		<canvas id="chart"></canvas>
	</div>
	
	<div id="result" class="result-box">
		Load a CSV or XLSX file above to begin designing your graphs.
	</div>
</div>

<div id="codeModal" class="modal-overlay">
	<div class="modal-content">
		<h3 class="modal-title">Python Code for Current Plot</h3>
		<p class="modal-subtitle">This code uses **pandas** for data manipulation and **matplotlib/seaborn** for plotting, matching your selections.</p>
		<pre id="codeDisplay"></pre>
		<div class="modal-button-group">
			<button id="copyCodeBtn" class="button-copy">
				Copy Code
			</button>
			<button id="closeModalBtn" class="button-close">
				Close
			</button>
		</div>
	</div>
</div>
<footer id="contact">
        <div class="footercontainer">
            <h3 class="langtitle">Connect with me for the better experience and the knowledge</h3>
        </div>
           <div class="social-links">
                <a href="https://www.youtube.com/@LEARNWITHSKADAM_6457" style="--accent-color:red;" aria-label="Youtube"><img src="/Images/youtube.jpg" alt="Youtube" width="31px"></a>
                <a href="https://github.com/Asura-824" style="--accent-color: rgb(52, 52, 52);" aria-label="Github"><img src="/Images/github.png" alt="Github" width="31px"></a>
                <a href="https://www.linkedin.com/in/shubham-kadam-b8856031a?lipi=urn%3Ali%3Apage%3Ad_flagship3_profile_view_base_contact_details%3BUAYDKko9S02GUSRNrD3vJg%3D%3D" style="--accent-color:rgb(25, 67, 233);" aria-label="Linkedin"><img src="/Images/linkedin.png" alt="Linkedin" width="35px"></a>
        </div>
            <p style="font-size:bold;">Made with ❤️ by SHUBHAM</p><br>
            <p>Code is like poetry Some get it,some don't<br>Those who don't get it,are <b style="color: #f80404;"> confused.</b><br>Those who get it,are even <b style="color:#f80404;">more confused.</b></p><br><br>
            <p class="copyright">© 2025 SHUBHAM's CodeQuotient. All rights reserved.</p>
    </footer>
<script>
// Global variables
const dropzone = document.getElementById('dropzone');
const fileInput = document.getElementById('fileInput');
const ctx = document.getElementById('chart').getContext('2d');
const resultDiv = document.getElementById('result');
const xSelectContainer = document.getElementById('xSelectContainer'); // Now a container for checkboxes
const ySelect = document.getElementById('ySelect');
const aggMethodSelect = document.getElementById('aggMethodSelect');
const plotTypeSelect = document.getElementById('plotTypeSelect');
const plotBtn = document.getElementById('plotBtn');
const codeBtn = document.getElementById('codeBtn');
const typeWarning = document.getElementById('typeWarning');

// Filter elements
const filterColSelect = document.getElementById('filterColSelect');
const filterOpSelect = document.getElementById('filterOpSelect');
const filterValueInput = document.getElementById('filterValueInput');

// Modal elements
const codeModal = document.getElementById('codeModal');
const codeDisplay = document.getElementById('codeDisplay');
const closeModalBtn = document.getElementById('closeModalBtn');
const copyCodeBtn = document.getElementById('copyCodeBtn');

let chart, parsedData = [], headers = [];

// Helper function to check if a column is predominantly numeric
function isColumnNumeric(col) {
	const values = parsedData.map(row => row[col]).filter(val => val !== null && val !== undefined && val !== '');
	if (values.length === 0) return false;

	let numericCount = 0;
	let totalCount = 0;
	values.forEach(val => {
		if (val !== null && val !== undefined && val !== '') {
			totalCount++;
			// Check if the value is a number after attempting a parse
			if (!isNaN(parseFloat(val)) && isFinite(val)) {
				numericCount++;
			}
		}
	});
	// Consider a column numeric if 80% or more of its non-null values are numbers
	return totalCount > 0 && (numericCount / totalCount) > 0.8;
}

// Function to safely prepare column names for HTML IDs/names
function safeString(s) {
	if (!s) return s;
	return s.trim().replace(/[^a-zA-Z0-9_]+/g, '_').toLowerCase();
}

// --- File Loading and Parsing ---
function loadFile(file) {
	const reader = new FileReader();
	const isExcel = file.name.endsWith('.xlsx');
	resultDiv.innerHTML = '<span class="text-blue-500">Loading and parsing file...</span>';
	codeBtn.disabled = true;
	if (chart) chart.destroy();

	reader.onload = e => {
		let rawData;
		if (isExcel) {
			const data = new Uint8Array(e.target.result);
			const workbook = XLSX.read(data, { type: 'array' });
			// Read the first sheet as CSV string
			rawData = XLSX.utils.sheet_to_csv(workbook.Sheets[workbook.SheetNames[0]]);
		} else {
			rawData = e.target.result;
		}

		Papa.parse(rawData, {
			header: true,
			dynamicTyping: true,
			skipEmptyLines: true,
			complete: ({ data, meta }) => handleParsedData(data, meta.fields)
		});
	};

	try {
		isExcel ? reader.readAsArrayBuffer(file) : reader.readAsText(file);
	} catch (error) {
		resultDiv.textContent = 'Error reading file: ' + error.message;
	}
}

function handleParsedData(data, fields) {
	// Filter out completely empty rows
	parsedData = data.filter(row => Object.values(row).some(val => val !== null && val !== '' && (typeof val !== 'string' || val.trim() !== '')));
	
	// Clean headers: filter out headers that don't appear in any data row
	headers = fields.filter(f => parsedData.some(row => row.hasOwnProperty(f)));

	if (headers.length === 0) {
		resultDiv.textContent = 'Error: The file appears empty or the header row is missing/invalid.';
		if (chart) chart.destroy();
		return;
	}

	populateSelectors(headers);
	resultDiv.textContent = `File loaded successfully! Found ${parsedData.length} records and ${headers.length} columns.`;
	// Automatically generate plot on load (if defaults are set)
	generatePlot(); 
}

function populateSelectors(fields) {
	[ySelect, filterColSelect].forEach(select => select.innerHTML = '');
	xSelectContainer.innerHTML = '';
	
	// Populate Y-Axis and Filter Column Selects
	filterColSelect.appendChild(new Option('(None)', ''));
	fields.forEach(f => {
		const opt = document.createElement('option');
		opt.value = opt.textContent = f;
		ySelect.appendChild(opt.cloneNode(true));
		filterColSelect.appendChild(opt);
	});
	
	// Populate Checkbox Container (X-Axis)
	fields.forEach(f => {
		const div = document.createElement('div');
		div.className = 'checkbox-item'; // Replaced Tailwind classes
		const input = document.createElement('input');
		input.type = 'checkbox';
		input.id = `x_col_${safeString(f)}`;
		input.value = f;
		input.name = 'x_cols';
		input.className = 'checkbox-input'; // Replaced Tailwind classes
		input.addEventListener('change', generatePlot);
		const label = document.createElement('label');
		label.htmlFor = `x_col_${safeString(f)}`;
		label.textContent = f;
		label.className = 'cursor-pointer';
		div.appendChild(input);
		div.appendChild(label);
		xSelectContainer.appendChild(div);
	});
	
	// --- Default Selections ---
	const firstCategoricalField = fields.find(f => !isColumnNumeric(f));
	if (firstCategoricalField) {
		const initialCheckbox = document.getElementById(`x_col_${safeString(firstCategoricalField)}`);
		if (initialCheckbox) {
			initialCheckbox.checked = true;
		}
	}
	// Default Y-Axis selection
	const numericField = fields.find(f => isColumnNumeric(f));
	if (numericField) {
		ySelect.value = numericField;
		aggMethodSelect.value = 'mean';
	} else if (fields.length > 0) {
		ySelect.value = fields[0];
		aggMethodSelect.value = 'count';
	}
}

// --- Data Processing (Filtering and Grouping) ---
function processDataForPlot(xCols, yCol, aggMethod, filterCol, filterOp, filterVal) {
	let data = parsedData;
	let yLabel = aggMethod.charAt(0).toUpperCase() + aggMethod.slice(1) + (aggMethod === 'count' ? ' (Records)' : ` of ${yCol}`);

	// 1. Filtering (applies to raw data)
	let filteredData = data;
	if (filterCol && filterVal) {
		let isNumericFilter = !isNaN(parseFloat(filterVal)) && isFinite(filterVal);
		let compareVal = isNumericFilter ? parseFloat(filterVal) : filterVal.toLowerCase();

		filteredData = data.filter(row => {
			const rowValue = row[filterCol];
			if (rowValue === null || rowValue === undefined) return false;

			let compareRowValue = isNumericFilter ? parseFloat(rowValue) : String(rowValue).toLowerCase();

			switch (filterOp) {
				case '===':
					return compareRowValue == compareVal;
				case '!==':
					return compareRowValue != compareVal;
				case '>':
					return compareRowValue > compareVal;
				case '<':
					return compareRowValue < compareVal;
				default:
					return true;
			}
		});
	}

	// 2. Grouping and Aggregation
	if (xCols.length === 0) {
		throw new Error("Please select at least one column for X-Axis (Group By).");
	}
	
	if (aggMethod !== 'count' && !isColumnNumeric(yCol)) {
		throw new Error(`The selected Y-Axis column ('${yCol}') is not numeric. Cannot calculate ${aggMethod}. Try 'Count'.`);
	}

	const groups = {};
	const separator = ' | '; // Separator to combine multiple column values into one label
	
	filteredData.forEach(row => {
		// Create a composite group key
		const groupKeyParts = xCols.map(col => row[col]);
		// Check if any part of the composite key is null/undefined/empty
		if (groupKeyParts.some(part => part === null || part === undefined || part === '')) return;
		
		const groupKey = groupKeyParts.join(separator);
		const aggValue = row[yCol];

		if (!groups[groupKey]) {
			groups[groupKey] = [];
		}

		// Push only valid aggregation values
		if (aggMethod === 'count') {
			groups[groupKey].push(1);
		} else if (typeof aggValue === 'number' && !isNaN(aggValue)) {
			groups[groupKey].push(aggValue);
		} else if (aggMethod !== 'count') {
			// Skip non-numeric values for non-count aggregation
		}
	});

	const labels = [];
	const values = [];

	// Sort keys alphabetically for consistent plot order
	Object.keys(groups).sort().forEach(key => {
		const groupValues = groups[key];
		if (groupValues.length > 0) {
			labels.push(key);
			let result;

			switch (aggMethod) {
				case 'sum':
					result = groupValues.reduce((a, b) => a + b, 0);
					break;
				case 'mean':
					result = groupValues.reduce((a, b) => a + b, 0) / groupValues.length;
					break;
				case 'min':
					result = Math.min(...groupValues);
					break;
				case 'max':
					result = Math.max(...groupValues);
					break;
				case 'count':
				default:
					result = groupValues.length;
					break;
			}
			values.push(result);
		}
	});

	if (labels.length === 0) {
		throw new Error("Grouping resulted in no valid data points. Check column types or filter.");
	}

	return { labels, values, yLabel, filteredLength: filteredData.length };
}

// --- Chart Generation ---
let chartConfig = {};

function generatePlot() {
	if (parsedData.length === 0) {
		if (chart) chart.destroy();
		resultDiv.textContent = 'Load a CSV or XLSX file above to begin designing your graphs.';
		codeBtn.disabled = true;
		return;
	}

	// 1. Get selections
	const xCheckboxes = Array.from(xSelectContainer.querySelectorAll('input[name="x_cols"]:checked'));
	const xCols = xCheckboxes.map(cb => cb.value);
	const yCol = ySelect.value;
	const aggMethod = aggMethodSelect.value;
	const plotType = plotTypeSelect.value;
	
	const filterCol = filterColSelect.value;
	const filterOp = filterOpSelect.value;
	const filterValue = filterValueInput.value.trim();

	// Clear previous chart
	if (chart) chart.destroy();
	codeBtn.disabled = true;

	try {
		// 2. Process data
		const { labels, values, yLabel, filteredLength } = processDataForPlot(
			xCols, yCol, aggMethod, filterCol, filterOp, filterValue
		);

		chartConfig = { xCols, yCol, aggMethod, plotType, yLabel, filterCol, filterOp, filterValue };

		// --- Chart.js Configuration ---
		const dataset = {
			label: yLabel,
			data: values,
			backgroundColor: 'rgba(59, 130, 246, 0.7)', // blue-500
			borderColor: plotType === 'line' ? 'rgba(22, 101, 242, 1)' : 'rgba(59, 130, 246, 1)', // blue-700
			borderWidth: 2,
			barPercentage: 0.9,
			categoryPercentage: 0.8,
			pointRadius: plotType === 'line' ? 4 : 0,
			tension: 0.4,
			fill: false
		};

		const options = {
			responsive: true,
			maintainAspectRatio: false,
			plugins: {
				title: {
					display: true,
					text: `${yLabel} of ${yCol} Grouped by ${xCols.join(' & ')} (Filtered N=${filteredLength}/${parsedData.length})`,
					font: { size: 18, weight: 'bold' }
				},
				legend: { display: true }
			},
			scales: {
				x: {
					title: {
						display: true,
						text: xCols.join(' - '),
						font: { weight: 'bold' }
					},
					type: 'category',
					labels: labels,
					// Rotate labels for multi-column grouping
					ticks: { maxRotation: 60, minRotation: 60 } 
				},
				y: {
					title: {
						display: true,
						text: yLabel,
						font: { weight: 'bold' }
					},
					beginAtZero: true
				}
			}
		};

		// Create the chart
		chart = new Chart(ctx, {
			type: plotType,
			data: {
				labels: labels,
				datasets: [dataset]
			},
			options: options
		});
		
		let statusMsg = `Aggregated plot generated successfully! Showing ${aggMethod.toUpperCase()} of ${yCol} grouped by ${xCols.join(' & ')}.`;
		if (filterCol && filterValue) {
			statusMsg += ` Filter applied: ${filterCol} ${filterOp} ${filterValue}.`;
		}
		statusMsg += `\nDisplaying ${labels.length} groups based on ${filteredLength}/${parsedData.length} records.`;
		resultDiv.textContent = statusMsg;
		codeBtn.disabled = false;

	} catch (error) {
		resultDiv.textContent = 'Error generating plot: ' + error.message;
		codeBtn.disabled = true;
	}
}

// --- Python Code Generation ---

function generatePythonCode() {
	if (Object.keys(chartConfig).length === 0) {
		return "# Please generate a plot first.";
	}

	const { xCols, yCol, aggMethod, plotType, yLabel, filterCol, filterOp, filterValue } = chartConfig;

	// Map JS operators to Python/Pandas syntax
	const pythonOp = filterOp === '===' ? '==' : filterOp === '!==' ? '!=' : filterOp;
	const filename = 'data.csv'; // Assuming the user will save the file as this
	const yColCode = aggMethod === 'count' ? 'Count_of_Records' : yCol;
	const xColList = xCols.map(col => `'${col}'`).join(', ');

	let pythonCode = `
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns # Used for better styling (optional)

# --- Configuration ---
FILE_NAME = '${filename}'
X_COLS = [${xColList}] # Multiple columns for hierarchical grouping
Y_COL = '${yCol}'
AGG_METHOD = '${aggMethod}'
Y_LABEL = '${yLabel}'
Y_PLOT_COL = '${yColCode}'

# NOTE: Assumes your data is saved as '${filename}' in the same directory.

# --- 1. Load and Prepare Data ---
try:
	# Read the data, ensuring headers are used
	df = pd.read_csv(FILE_NAME)
	
	# Ensure the Y column is numeric (coercing errors will turn non-numeric into NaN)
	df[Y_COL] = pd.to_numeric(df[Y_COL], errors='coerce')
	
	# Drop rows where the critical X or Y columns are null
	df.dropna(subset=[*X_COLS, Y_COL], inplace=True)
except FileNotFoundError:
	print(f"Error: File '{FILE_NAME}' not found.")
	exit()

# --- 2. Filtering ---
filtered_df = df.copy()
`;
	
	if (filterCol && filterValue) {
		const isNumericFilter = !isNaN(parseFloat(filterValue)) && isFinite(filterValue);
		const filterValCode = isNumericFilter ? parseFloat(filterValue) : `'${filterValue}'`;
		
		pythonCode += `
# Filter the DataFrame: ${filterCol} ${pythonOp} ${filterValCode}
filter_col = '${filterCol}'
filter_op = '${pythonOp}'
filter_val = ${filterValCode}

# If the filter column is categorical/string, we cast it to string for robust comparison
if filter_op in ['==', '!=']:
	filtered_df = filtered_df[filtered_df[filter_col].astype(str).str.strip() ${pythonOp} str(filter_val).strip()]
else:
	# Use numeric comparison
	filtered_df = filtered_df[filtered_df[filter_col] ${pythonOp} filter_val]

print(f"Filtered Data Size: {len(filtered_df)}")
if filtered_df.empty:
	print("Error: Filtering resulted in an empty DataFrame.")
	exit()

`;
	}

	pythonCode += `
# --- 3. Grouping and Aggregation ---

if AGG_METHOD == 'count':
	# For count, we group by X columns and get the size of each group
	aggregated_df = filtered_df.groupby(X_COLS).size().reset_index(name=Y_PLOT_COL)
elif AGG_METHOD == 'sum':
	aggregated_df = filtered_df.groupby(X_COLS)[Y_COL].sum().reset_index(name=Y_PLOT_COL)
elif AGG_METHOD == 'mean':
	aggregated_df = filtered_df.groupby(X_COLS)[Y_COL].mean().reset_index(name=Y_PLOT_COL)
elif AGG_METHOD == 'min':
	aggregated_df = filtered_df.groupby(X_COLS)[Y_COL].min().reset_index(name=Y_PLOT_COL)
elif AGG_METHOD == 'max':
	aggregated_df = filtered_df.groupby(X_COLS)[Y_COL].max().reset_index(name=Y_PLOT_COL)
else:
	print(f"Error: Unknown aggregation method {AGG_METHOD}")
	exit()

# Create a combined label for the x-axis for multi-column grouping
X_PLOT_COL = 'Group_Label'
if len(X_COLS) > 1:
    aggregated_df[X_PLOT_COL] = aggregated_df[X_COLS].astype(str).agg(' - '.join, axis=1)
else:
    aggregated_df[X_PLOT_COL] = aggregated_df[X_COLS[0]]

print("Aggregated Results:")
print(aggregated_df.head())
print(f"Number of groups: {len(aggregated_df)}")

# --- 4. Plotting using Matplotlib/Seaborn ---

# Set a style for better visualization
sns.set_theme(style="whitegrid")
plt.figure(figsize=(12, 6))

`;

	if (plotType === 'bar') {
		pythonCode += `
# Bar Plot
# Use plt.bar for simple plots. Set color to match web app aesthetic.
plt.bar(aggregated_df[X_PLOT_COL], aggregated_df[Y_PLOT_COL], color='#3b82f6') # blue-500
plt.title(f'{Y_LABEL} of {Y_COL} Grouped by {", ".join(X_COLS)}', fontsize=16, pad=15)
plt.xlabel(", ".join(X_COLS), fontsize=12)
plt.ylabel(Y_PLOT_COL, fontsize=12)
plt.xticks(rotation=60, ha='right') # Rotate for readability
plt.tight_layout()
plt.show()
`;
	} else if (plotType === 'line') {
		pythonCode += `
# Line Plot
plt.plot(aggregated_df[X_PLOT_COL], aggregated_df[Y_PLOT_COL], 
         linestyle='-', marker='o', markersize=6, color='#3b82f6') # blue-500
plt.title(f'Trend of {Y_LABEL} over {", ".join(X_COLS)}', fontsize=16, pad=15)
plt.xlabel(", ".join(X_COLS), fontsize=12)
plt.ylabel(Y_PLOT_COL, fontsize=12)
plt.xticks(rotation=60, ha='right')
plt.grid(True, linestyle='--', alpha=0.7)
plt.tight_layout()
plt.show()
`;
	}

	return pythonCode;
}

// --- Event Listeners ---

// Drag and drop events
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
	dropzone.addEventListener(eventName, e => {
		e.preventDefault();
		e.stopPropagation();
	}, false);
});

['dragenter', 'dragover'].forEach(eventName => {
	dropzone.addEventListener(eventName, () => dropzone.style.borderColor = '#3b82f6', false);
});

['dragleave', 'drop'].forEach(eventName => {
	dropzone.addEventListener(eventName, () => dropzone.style.borderColor = '#d1d5db', false);
});

dropzone.addEventListener('drop', e => {
	const dt = e.dataTransfer;
	const files = dt.files;
	if (files.length > 0) loadFile(files[0]);
}, false);

fileInput.addEventListener('change', e => {
	if (e.target.files.length > 0) loadFile(e.target.files[0]);
});

// Controls change events
[ySelect, aggMethodSelect, plotTypeSelect, filterColSelect, filterOpSelect, filterValueInput].forEach(el =>
	el.addEventListener('change', generatePlot)
);

// Plot button click explicitly calls generatePlot
plotBtn.addEventListener('click', generatePlot);


// Code Modal Events
codeBtn.addEventListener('click', () => {
	if (Object.keys(chartConfig).length > 0) {
		codeDisplay.textContent = generatePythonCode();
		codeModal.style.display = 'flex';
	}
});

closeModalBtn.addEventListener('click', () => codeModal.style.display = 'none');
codeModal.addEventListener('click', (e) => { // Close when clicking outside the content
	if (e.target.classList.contains('modal-overlay')) {
		codeModal.style.display = 'none';
	}
});

copyCodeBtn.addEventListener('click', () => {
	const text = codeDisplay.textContent;
	const tempTextArea = document.createElement('textarea');
    tempTextArea.value = text;
	tempTextArea.style.position = 'fixed'; 
    document.body.appendChild(tempTextArea);
    tempTextArea.select();
	try {
        document.execCommand('copy');
        resultDiv.textContent = 'Python code copied to clipboard!';
    } catch (err) {
        resultDiv.textContent = 'Could not copy text. Please select and copy manually.';
    }
    document.body.removeChild(tempTextArea);
});

// Initial load suggestion
document.addEventListener('DOMContentLoaded', () => {
	resultDiv.textContent = 'Interactive Data Visualizer Ready. Please load a data file.';
});
</script>
</body>
</html>